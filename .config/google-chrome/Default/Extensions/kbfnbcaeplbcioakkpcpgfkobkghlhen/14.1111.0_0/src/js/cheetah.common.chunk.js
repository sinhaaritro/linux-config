(self.webpackChunk=self.webpackChunk||[]).push([[4382],{74486:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>De});var s=i(17771),n=i(17889),a=i(75668),o=i(85892),r=i(57050),l=i(27378),c=i(8482),d=i(74850),h=i(5817),u=i(14601),p=i(32952),g=i(24209),m=i(85985),_=i(23063),v=i(66310),b=i(50628),f=i(40151),S=i(98403),w=i(2844),y=i(77176),R=i(2834),I=i(76974),C=i(28043),E=i(93508),U=i(16118),x=i(13444),k=i(78674),A=i(60797),P=i(17343),M=i(80544),B=i(79692),G=i(67434),O=i(19751),F=i(44586),N=i(97425),z=i(5114),T=i(8125),q=i(83078),H=i(22232),D=i(62965),W=i(95574),V=i(12187),L=i(38983),Q=i(34217),Z=i(58541),j=i.n(Z);const Y=({width:e,height:t,top:i,left:s})=>l.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",className:j().highlightRect,style:{width:e,height:t,top:i,left:s}});var K=i(20855),$=i(74229);const X=l.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},n){return l.createElement(K.u,{message:"Open GrammarlyGO",forcedMessage:e},l.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:$.ideateButton,ref:n,onMouseEnter:i,onMouseLeave:s},l.createElement("div",{className:$.ideateButtonIcon})))}));var J=i(61862),ee=i(86620),te=i(92132),ie=i(49468),se=i(89894),ne=i(33678),ae=i(15073),oe=i(42103),re=i(51369);const le=se.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),ce=({env:e,children:t})=>l.createElement(ie.o,null,l.createElement(ne.a.Context.Provider,{value:new ee.C(e)},l.createElement(te.Q,{remSize:I.of(16),setter:e=>ae.u.setRootCssVar(document.documentElement,e)},l.createElement(oe.G.DefaultProvider,null,l.createElement("div",{className:le},t,l.createElement(re.X,null))))));var de=i(74204),he=i(62810);const ue=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:n})=>{const[a,o]=l.useState(null),{styles:r,attributes:c}=(0,de.D)(e,a,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return l.createElement("button",{ref:o,style:r.popper,...c.popper,onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:he.replyButton,"data-disabled":s},l.createElement("div",{className:he.icon}),l.createElement("span",null,"Reply quickly"))};var pe=i(73734);const ge=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:n,onOpenRewriteClick:a})=>{const[o,r]=l.useState(null),{styles:c,attributes:d}=(0,de.D)(e,o,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return n||a?l.createElement("div",{ref:r,style:c.popper,...d.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:pe.entryButton,"data-disabled":s},n?l.createElement(K.u,{message:"Improve it"},l.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:pe.entryButtonItem,"data-disabled":s},l.createElement("i",{className:pe.rewriteIcon}))):null,a?l.createElement(K.u,{message:"Open GrammarlyGO"},l.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:pe.entryButtonItem,"data-disabled":s},l.createElement("i",{className:pe.openIcon}))):null):null};var me=i(90845),_e=i(49708),ve=i(5739),be=i(60688);const fe=()=>l.createElement("svg",{className:be.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},l.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),l.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),Se=({overflow:e,...t})=>e?l.createElement(ye,{...t}):l.createElement(we,{...t}),we=({left:e,top:t,height:i})=>l.createElement(l.Fragment,null,l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:be.quasiCaret,style:{left:e,top:t+i,height:i+8}},l.createElement(fe,null))),ye=({left:e,top:t,height:i})=>{const{ref:n,onMount:a}=me.P.useElWatcher(),o=l.useMemo((()=>L.h.create(z.none)),[]),{rect:c,onMount:d}=me.P.useRectWatcher(),h=l.useCallback((e=>{e.style.pointerEvents="all",o.set((0,r.zG)(s.Yt(z.option)({rect:z.some(e.getBoundingClientRect()),goodParent:(0,r.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return z.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),z.filter((t=>t===e||e.contains(t||null))))}),z.fold((()=>z.none),(({rect:e})=>z.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=l.useMemo((()=>_e.R(document,"scroll",{capture:!0}).pipe(E.O(null))),[]);return me.P.useSubscriptionTo(w.aj([n.pipe(A.oA),u,c]).pipe(R.b((([e])=>h(e))))),l.createElement(l.Fragment,null,l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:be.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{a(e),d(e)}},l.createElement(ve.F.div,{style:o.pipe(y.U((e=>(0,r.zG)(e,z.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},l.createElement(fe,null))),l.createElement(ve.F.Fragment,null,o.pipe(y.U((e=>(0,r.zG)(e,z.fold(r.gn,(e=>l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:be.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},l.createElement(fe,null))))))))))};var Re=i(95572),Ie=i(64015),Ce=i(55073),Ee=i(22337),Ue=i(77993),xe=i(35152),ke=i(4120),Ae=i(39464),Pe=i(8961),Me=i(62111),Be=i(95195);function Ge(e){return(0,r.zG)(decodeURIComponent(e),(t=>{try{const e=JSON.parse(t);return xe.Zq.codec.decode(e)}catch(t){return Be.t$(`Cannot parse raw Cheetah onboarding state: ${e}.`)}}),Be.fS((()=>xe.Zq.State.empty)))}function Oe(e){return encodeURIComponent(JSON.stringify(xe.Zq.codec.encode(e)))}var Fe=i(23423),Ne=i(81531),ze=i(30732);const Te=(0,V.xb)(X),qe=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),He=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);class De{constructor(e,t,i,s,n,o,l,c,h,C,E,U,x,k,A,P,q){this._integration=e,this._textChangeBuffer=t,this._checkingService=i,this._textStats=s,this._csPageState=n,this._cheetahCSActions=o,this._dapiActions=l,this._dapiSettings=c,this._closeGrammarlyAssistant=h,this._getEnv=C,this._featureFlags=E,this._user=U,this._gButtonPopupState=x,this._gButtonDisabledReason=k,this._sessionStartedUsageInfo=A,this._domain=P,this._gnar=q,this._subs=new u.w,this._log=d.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=L.h.create(null),this._ideateButtonUI=L.h.create(null),this._expandedIdeateButtonUI=L.h.create(null),this._assistantUI=L.h.create(null),this._highlightUI=L.h.create(null),this._quasiCaretUI=L.h.create(null),this._onboardingUI=L.h.create(null),this._nativeCursorHider=L.h.create(z.none),this._lastRestartAttemptTime=L.h.create(0),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this._ideateButtonTooltipNotificationState=L.h.create(z.none),this._relevantCAPIEvents=new p.xQ,this._assistantFocused=L.h.create(!1),this._inlineButtonRecentlyPressed=L.h.create(!1),this._ideateButtonRecentlyHovered=L.h.create(!1),this._selectionRange=L.h.create(z.none),this._highlightRects=L.h.create([]),this._quasiCaretRect=L.h.create(z.none),this._assistantSession=L.h.create(z.none),this._onboardingViewModel=L.h.create(z.none),this._ideateButtonRefChange=new p.xQ,this._disposed=new p.xQ,this._initialOnboardingBlockedForSession=L.h.create(!1),this._cheetahServices=function(e,t,i,s,n,o,l,c,d,h,g,b,f,S,C,E,U,x,k){const A=new p.xQ,P=new Ee.c3((()=>(0,r.zG)(e.get(),z.map((e=>({sendUserAction:(t,i)=>D.fj((()=>W.vM((()=>e.sendUserAction(t,i)))))}))),z.toNullable))),T={user:i.view((e=>({isFree:ke.n5.isFree(e)})))},q=new Ee.$C(I.of(o),t.pipe(m.h(Ue.Q.isCheetahSetContext)),t.pipe(m.h(Ue.Q.isCheetahResult))),V=s.pipe(v.w(z.fold((()=>I.of(z.none)),(e=>e.sessionService.session.view(z.some))))),L=new Set;f.rewrite&&S||L.add(xe.TG.StepName.rewrite);f.compose||L.add(xe.TG.StepName.initial);f.onboarding||(L.add(xe.TG.StepName.initial),L.add(xe.TG.StepName.rewrite),L.add(xe.TG.StepName.prompts),L.add(xe.TG.StepName.review));const Q=l.pipe(M.QV(B.E),G.R(((e,t)=>{const i=e.filter(Le);return t&&Le(t)?[...i,t]:i}),[]),y.U(Ie.Z$),O.shareReplay({bufferSize:1,refCount:!0})),Z=w.aj([Q,c,d]).pipe(y.U((([e,t,i])=>(0,r.zG)(e,z.filter((()=>t)),z.fold((()=>({})),(e=>({[xe.nF.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[xe.nF.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),j=s.pipe(v.w(z.fold((()=>I.of(!1)),(e=>e.viewModels.position.state.view((e=>"dragged"===e.kind&&e.dragging)))))),Y=e=>{null==k||k.debug(`Completing step [${e}]`);g.get()[e].extension.completed||b({[e]:{completed:!0,lastSeen:Date.now()}})};return{userService:T,availabilityService:q,trackingService:P,textEditorService:{flush:()=>new F.y((t=>{const i=new u.w;return C.empty.get()?t.next(void 0):(C.flush(),(0,r.zG)(e.get(),z.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(m.h((e=>e._tag===Re.J8.Type.submitOtAck)),N.L(500,I.of(null)),R.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(_.q(1)).toPromise(),getText:E,insertText:U},feedbackService:{submitFeedback:e=>{x.feedbackFormSubmit(e.mood,e.source===xe.x2.Source.resultCard?"cheetah-card":e.source===xe.x2.Source.quickReplyInitialActions?"cheetah-quick-reply":(0,H.L0)(e.source),e.domain,e.message)}},uphookService:{onShowGetMorePrompts:e=>{e&&((0,Fe.n)(x,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),(0,Me.Tb)().upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))},onClickGetMorePrompts:e=>{e?((0,Fe.Q)(x,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),(0,Me.Tb)().upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,Ae.wW)("upHook","grammarlyGoPrompts")):self.open(a.Rd().appConfig.url.support)}},createOnboardingViewModel:()=>(0,Pe.kF)({upstreamOnboardingState:g,session:V,textStats:n,forceDisabledOnboardingSteps:L,assistantUIActions:A,externalElements:Z,hideAssistantOnboardingTooltips:j,promptsAllocated:q.promptsAllocated,client:"extension",trackingService:P,disposed:h,logger:Ne.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:Y}),notifyAssistantUIAction:e=>A.next(e),dispose:()=>q.dispose()}}(this._checkingService,this._relevantCAPIEvents,this._user,this._assistantSession,this._textStats,this._sessionStartedUsageInfo,this._ideateButtonRefChange,L.h.combine(this._integration.canShowIdeateButtonPopups,this._gButtonPopupState.view("type").view((e=>!qe.has(e))),T.xD),L.h.combine(this._csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),g.T(this._csPageState.view("isActiveTab").pipe(m.h((e=>!e))),this._disposed).pipe(_.q(1)),this._dapiSettings.view((e=>function(e){const t=xe.Zq.State.toClientState(Ge(e.extension||""),"extension"),i=xe.Zq.State.toClientState(Ge(e.editor||""),"editor"),s=xe.Zq.State.toClientState(Ge(e.llamaMac||""),"llamaMac"),n=xe.Zq.State.toClientState(Ge(e.llamaWindows||""),"llamaWin");return(0,r.zG)(xe.Zq.State.empty,xe.Zq.State.patch(t,"extension"),xe.Zq.State.patch(i,"editor"),xe.Zq.State.patch(s,"llamaMac"),xe.Zq.State.patch(n,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._dapiActions.modifyCheetahOnboardingState((0,r.ls)(Ge,(t=>(0,r.zG)(xe.Zq.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>xe.Zq.State.patch(e,"extension")(t)))),Oe))}),this._featureFlags,this._integration.enableInlineRewrites,this._textChangeBuffer,(e=>this._integration.getText(e)),(e=>this._insertText(e)),this._gnar,this._log),this._isOnboardingPopupVisible=L.h.create(!1),this._entryPointsEnabled=L.h.create(!1),this.isAssistantOpened=this._assistantSession.view(z.isSome),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isCheetahAvailable=this._cheetahServices.availabilityService.availability.view((0,T.ff)(xe.a8.isUnavailable)),this._dapiActions.reloadPropsRateLimited(),this._subs.add(this._checkingService.pipe(m.h(z.isSome),v.w((e=>e.value.readyState)),m.h((e=>e===Re.kQ.ready)),b.P()).subscribe((()=>this._init()))),this._subs.add(this._listenToMonitoringEvents()),this._subs.add(this._setupIdeateTooltipStateObs()),this._subs.add(this._onboardingViewModel.pipe(v.w(z.fold((()=>f.E),(e=>e.uiActions))),m.h(Ze)).subscribe((()=>{this._cheetahCSActions.initialOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive(xe.TG.StepName.initial).subscribe(S.wW(this._isOnboardingPopupVisible))),this._subs.add(this._gButtonPopupState.view("type").view((e=>He.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(w.aj([this._gButtonDisabledReason,this._integration.entryPointsEnabled]).pipe(y.U((([e,t])=>t&&!function(e){const t=new Set([ze.P.DATA_CONTROL_ACTIVE,ze.P.OFFLINE,ze.P.STAND_WITH_UKRAINE,ze.P.USER_CLAIMED,ze.P.USER_EDC_BLOCKED,ze.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(S.wW(this._entryPointsEnabled))),this._registerDebugHelpers()}onRelevantCAPIEvent(e){this._relevantCAPIEvents.next(e)}closeAssistant(e){this._terminateAssistantSession(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._getInlineButtonUI().subscribe(S.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(S.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(S.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getAssistantUI().subscribe(S.wW(this._assistantUI))),this._subs.add(this._getHighlightUI().subscribe(S.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(S.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(S.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(S.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(S.wW(this._highlightRects))),this._subs.add(this._updateQuasiCaretRect().subscribe(S.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this._assistantSession.view(z.isSome).subscribe((e=>{e&&this._closeGrammarlyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModel.pipe(v.w(z.fold((()=>f.E),(e=>e.uiActions))),m.h(xe.lG.is(xe.lG.Kind.tryItOut)),R.b((()=>this._startNewAssistantSession(We(this._integration.quickReplyContext.get())&&this._featureFlags.quickReply?xe.z_.Mode.quickReply:xe.z_.Mode.ideation))))}_getOnboardingVMStepActive(e){return this._onboardingViewModel.pipe(v.w(z.fold((()=>I.of(!1)),(t=>t.activeStep.view((0,r.ls)(z.filter((e=>e.show)),z.map((e=>e.name)),q.FX(e)))))),C.x())}_listenToMonitoringEvents(){return Ee.gz.getInstance().events.subscribe((e=>{this._log.info("received monitoring event",{ev:e}),(0,r.zG)(this._checkingService.get(),q.bw((t=>{xe._H.isError(e)?((0,Me.Tb)().cheetah.error(e,this._domain,t.sessionUuid),e.name!==xe._H.Error.Name.waitForContextTimeout&&e.name!==xe._H.Error.Name.waitForAckTimeout||"startSession"!==e.sourceEvent||(Date.now()-this._lastRestartAttemptTime.get()>h.LK(5)?(this._lastRestartAttemptTime.set(Date.now()),this._restartSession()):(0,Me.Tb)().cheetah.sessionRestartTimeout(e.name===xe._H.Error.Name.waitForAckTimeout?"ack":e.name===xe._H.Error.Name.waitForContextTimeout?"setContext":(0,H.L0)(e),this._domain,t.sessionUuid))):xe._H.isInfo(e)?(0,Me.Tb)().cheetah.info(e,this._domain,t.sessionUuid):(0,H.L0)(e)})))}))}_setupIdeateTooltipStateObs(){return this._cheetahServices.availabilityService.availability.pipe(E.O(null),U.G(),y.U((([e,t])=>e&&t&&xe.a8.isPassive(e)&&xe.a8.isActive(t)?z.some("Youâ€™ve got prompts!"):z.none)),v.w(z.fold((()=>I.of(z.none)),(e=>g.T(I.of(z.some(e)),I.of(z.none).pipe(x.g(3e3))))))).subscribe(S.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({services:this._cheetahServices,clearOnboarding:()=>this._dapiActions.modifyCheetahOnboardingState((()=>Oe(xe.Zq.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return this._cheetahServices.availabilityService.availability.view(xe.a8.isUsable).pipe(R.b((e=>this._onboardingViewModel.modify((t=>((0,r.zG)(t,q.bw((e=>e.dispose()))),e?z.some(this._cheetahServices.createOnboardingViewModel()):z.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(k.b(100),m.h((e=>!e&&(0,r.zG)(this._assistantSession.get(),z.fold(r.jv,(e=>e.sessionService.session.view((e=>"started"===e.kind&&xe.z_.Mode.isRewriteOrQuickRewrite(e.mode)&&z.isNone(e.inProgressResult)&&0===e.resultHistory.length)).get()))))),R.b((()=>this._terminateAssistantSession(xe.z_.EndReason.assistantBlurred))))}_onClickIdeateButton(e){z.isSome(this._assistantSession.get())?this._terminateAssistantSession(xe.z_.EndReason.closed):this._startNewAssistantSession(e)}_updateSelectionRange(){return w.aj([this._integration.selectionRange,this._assistantUI.pipe(m.h((e=>null===e)))]).pipe(y.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantIsHidden:t}))),R.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),m.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:n,assistantIsHidden:a})=>!!a||!i&&!s&&(!z.isNone(e)||!t&&!n))),y.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return this._selectionRange.pipe(v.w(z.fold((()=>I.of([])),(e=>this._integration.getHighlightRects(e)))))}_updateQuasiCaretRect(){return this._selectionRange.pipe(v.w((e=>(0,r.zG)(e,z.filter(c.SV.isCollapsed),z.fold((()=>I.of([])),(e=>this._integration.getHighlightRects(e)))))),y.U((e=>(0,r.zG)(e,n.c2,z.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return L.h.combine(this._quasiCaretRect,this._assistantSession.view(z.isSome),((e,t)=>(0,r.zG)(s.Yt(z.option)({nativeUIHider:z.fromNullable(this._integration.createNativeUIHider),quasiCaretRect:e}),z.filter((()=>t)),q.ew((()=>{this._nativeCursorHider.modify((e=>((0,r.zG)(e,q.bw((e=>e.dispose()))),z.none)))})),q.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,r.zG)(t,q.bw((e=>e.dispose()))),z.some(e()))))})))))}_terminateAssistantSession(e){this._assistantSession.modify(z.chain((t=>(t.dispose(e),z.none)))),e!==xe.z_.EndReason.closed&&e!==xe.z_.EndReason.textInserted&&e!==xe.z_.EndReason.assistantBlurred||this._integration.focusTextField()}_restartSession(){this._log.info("reconnecting checking service and restarting session"),(0,r.zG)(this._assistantSession.get(),q.bw((e=>{const t=e.sessionService.session.get().mode;e.dispose(xe.z_.EndReason.disposed),this._assistantSession.set(z.none),(0,r.zG)(this._checkingService.get(),q.bw((e=>{e.reconnect()}))),this._startNewAssistantSession(t)})))}_startNewAssistantSession(e){this._assistantFocused.set(!0);const t=xe.z_.Mode.isIdeation(e)?{mode:e}:xe.z_.Mode.isRewriteOrQuickRewrite(e)?{mode:e,selectedRange:(0,r.zG)(this._selectionRange.get(),z.getOrElseW((()=>({start:0,end:0}))))}:xe.z_.Mode.isQuickReply(e)?{mode:e,quickReplyContext:(0,r.zG)(this._integration.quickReplyContext.get(),z.fold((()=>xe.H3.empty),Ve))}:(0,H.vE)(e),i=new Ee.ZP({startSessionOptions:t,textEditorService:this._cheetahServices.textEditorService,getCAPIClient:()=>(0,r.zG)(this._checkingService.get(),z.map((e=>({cheetahStartSession:t=>D.fj((()=>W.vM((()=>e.cheetahStartSession(t))))),cheetahAction:t=>D.fj((()=>W.vM((()=>e.cheetahAction(t))))),cheetahInterrupt:t=>D.fj((()=>W.vM((()=>e.cheetahInterrupt(t))))),cheetahSetVoice:t=>D.fj((()=>W.vM((()=>e.cheetahSetVoice(t))))),cheetahEndSession:()=>D.fj((()=>W.vM((()=>e.cheetahEndSession())))),setSessionOption:t=>D.fj((()=>W.vM((()=>e.setSessionOption(t)))))}))),z.toNullable),relevantCAPIEvents:this._relevantCAPIEvents.asObservable(),upstreamDialect:this._dapiSettings.view((({dialectWeak:e,dialectStrong:t})=>t?xe.LA.Dialect.Value.fromString(t):e?xe.LA.Dialect.Value.fromString(e):xe.LA.Dialect.Value.american)),onVoiceProfileSelectedDialectChange:e=>{this._dapiActions.changeStrongDialect(e)},trackingService:this._cheetahServices.trackingService}),s=J.TB.create(this._cheetahServices.userService,this._cheetahServices.availabilityService,this._cheetahServices.trackingService,this._cheetahServices.textEditorService,this._cheetahServices.uphookService,this._cheetahServices.feedbackService,i,{notify:e=>this._cheetahServices.notifyAssistantUIAction(e),onFocus:e=>this._assistantFocused.set(e),close:e=>this._terminateAssistantSession(e)},this._integration.assistantPlacement.pipe(A.oA)),n={sessionService:i,viewModels:s,dispose:e=>{i.dispose(e),s.dispose(),this._assistantFocused.set(!1)}};this._assistantSession.set(z.some(n))}_getInlineButtonUI(){return(0,r.zG)(s.Yt(o.P)({inlineButtonInfo:this._integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:g.T(this._integration.selectionRange.pipe(y.U((e=>(0,r.zG)(e,z.isSome)))),this._integration.selectionRange.pipe(k.b(100),P.h(!1))),assistantClosed:this._assistantSession.view(z.isNone),textMapIsEmpty:this._integration.textMapIsEmpty,quickReplyContext:this._integration.quickReplyContext,availability:this._cheetahServices.availabilityService.availability,entryPointsEnabled:this._entryPointsEnabled})).pipe(y.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantClosed:s,textMapIsEmpty:n,quickReplyContext:a,availability:o,entryPointsEnabled:c})=>(0,r.zG)(e,z.filter((()=>c)),z.filter((()=>s)),z.filter((()=>xe.a8.isUsable(o))),z.fold(r.gn,(e=>(0,r.zG)(t,z.fold(r.gn,(t=>n&&z.isSome(a)&&this._featureFlags.inlineQuickReply?l.createElement(ue,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:z.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(xe.z_.Mode.quickReply)}}):Qe(t)&&(this._featureFlags.inlineRewrite||this._featureFlags.magicRewrite)&&this._integration.enableInlineRewrites?l.createElement(ge,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:z.toNullable(e.offset),onOpenRewriteClick:this._featureFlags.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(xe.z_.Mode.rewrite)}:void 0,onMagicRewriteClick:this._featureFlags.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(xe.z_.Mode.quickRewrite)}:void 0}):null)))))))))}_getAssistantUI(){return this._assistantSession.view(z.fold(r.gn,(e=>l.createElement(ce,{env:this._getEnv()},Q.UI.mount((0,J.aK)(e.viewModels.assistant),(0,J.WY)(e.viewModels,{showDomainCheckbox:z.some(this._domain)}))))))}_getOnboardingUI(){return this._onboardingViewModel.view(z.fold(r.gn,(e=>l.createElement(ce,{env:this._getEnv()},Q.UI.mount(Pe.gy,(0,Pe.Bx)(e))))))}_getHighlightUI(){return L.h.combine(this._highlightRects,this._assistantSession.view(z.isSome),this._assistantFocused,((e,t,i)=>t&&i?e.map(((e,t)=>l.createElement(Y,{key:`cheetah-highlight-rect-${t}`,top:e.top,left:e.left,width:e.width,height:e.height}))):null))}_getQuasiCaretUI(){return L.h.combine(this._quasiCaretRect,this._assistantSession.view(z.isSome),((e,t)=>(0,r.zG)(e,z.filter((()=>t)),z.fold((()=>null),(e=>l.createElement(Se,{left:e.left,top:e.top,height:e.height,overflow:this._integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return w.aj([this._inlineButtonUI,this._selectionRange,this._integration.quickReplyContext,this._cheetahServices.availabilityService.availability,this._entryPointsEnabled]).pipe(y.U((([e,t,i,s,n])=>(0,r.zG)(e,z.fromPredicate((e=>null===e)),z.filter((()=>n)),z.filter((()=>xe.a8.isUsable(s))),z.fold(r.gn,(()=>this._getIdeateButtonForSelectionRange(t,i)))))))}_getExpandedIdeateButtonUI(){return w.aj([this._selectionRange,this._integration.quickReplyContext,this._cheetahServices.availabilityService.availability,this._entryPointsEnabled]).pipe(y.U((([e,t,i,s])=>(0,r.zG)(i,z.fromPredicate((e=>xe.a8.isVisible(e))),z.filter((()=>s)),z.fold(r.gn,(()=>this._getIdeateButtonForSelectionRange(e,t)))))))}_getIdeateButtonForSelectionRange(e,t){return(0,r.zG)(e,z.filter((e=>Qe(e)&&this._featureFlags.rewrite)),z.fold((()=>We(t)&&this._featureFlags.quickReply?xe.z_.Mode.quickReply:this._featureFlags.compose?xe.z_.Mode.ideation:null),(()=>xe.z_.Mode.rewrite)),z.fromNullable,z.fold(r.gn,(e=>l.createElement(Te,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(z.toUndefined)}))))}_insertText(e){""!==e?this._integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._terminateAssistantSession(xe.z_.EndReason.disposed),null===(e=z.toUndefined(this._onboardingViewModel.get()))||void 0===e||e.dispose(),this._cheetahServices.dispose(),this._subs.unsubscribe(),(0,r.zG)(this._nativeCursorHider.get(),q.bw((e=>e.dispose()))),this._integration.dispose()}}function We(e){return(0,r.zG)(e,z.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function Ve(e){var t,i,s,n,a,o,l,c,d,h,u,p,g,m,_,v,b;const f=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},S=f(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),w=f(null===(o=null===(a=null===(n=e.parents)||void 0===n?void 0:n[0])||void 0===a?void 0:a.audience)||void 0===o?void 0:o.undisclosedRecipients),y=f(null===(h=null===(d=null===(c=null===(l=e.parents)||void 0===l?void 0:l[0])||void 0===c?void 0:c.audience)||void 0===d?void 0:d.recipients)||void 0===h?void 0:h.filter((({email:e})=>void 0!==e&&!S.has(e)&&!w.has(e)))),R=f(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),I=f(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),C=f(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>void 0!==e&&!R.has(e)&&!I.has(e))));return{previousMessageInfo:(0,r.zG)(Ie.YM(null!==(_=e.parents)&&void 0!==_?_:[]),z.fold((()=>xe.H3.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,r.zG)(Ie.YM(null!==(t=e.authors)&&void 0!==t?t:[]),z.fold((()=>xe.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(y.values()),text:e.delta?(0,Ce.l)(e.delta,""):""}}))),title:null!==(v=e.title)&&void 0!==v?v:"",author:(0,r.zG)(Ie.YM(null!==(b=e.authors)&&void 0!==b?b:[]),z.fold((()=>xe.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(C.values()),indirectRecipients:Array.from(R.values()),undisclosedRecipients:Array.from(I.values())}}function Le(e){return e.isConnected&&null!==e.offsetParent}function Qe(e){const t=e.end-e.start;return t>=10&&t<5e3}function Ze(e){return(0,T.W9)(xe.lG.is(xe.lG.Kind.mount),(e=>e.step===xe.TG.StepName.initial))(e)}},86620:(e,t,i)=>{i.d(t,{C:()=>c,U:()=>s});var s,n=i(27378),a=i(29511),o=i(33678),r=i(88056),l=i(95574);!function(e){let t;!function(e){e.isAppleSystem="isAppleSystem"}(t=e.SidebarFlag||(e.SidebarFlag={})),e.Flag={...t,...o.a.Flag},e.Context=n.createContext(r.Y.invariantContent("Environment"))}(s||(s={}));class c{constructor(e=(0,a.O)()){this._flags=new Set,this.actions={openUrl:e=>l.vM((()=>{document.location.href=e.toString()})),openPopup:e=>l.vM((()=>{const t=self.open(e.toString(),void 0,"noreferrer");t&&(t.opener=null)}))},e.config.systemInfo.os.isMac&&this._flags.add(s.Flag.isAppleSystem),this._flags.add(s.Flag.supportsSVGDominantBaseline),this._flags.add(s.Flag.onlyTrustedEvents)}has(e){return this._flags.has(e)}}},92132:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),n=i(15073),a=i(60797),o=i(95300),r=i(5114);const l=({children:e,remSize:t,setter:i})=>(c+=1,s.useEffect((()=>{const e=t.subscribe((e=>{d.next(r.some(e)),i(r.some(e))}));return()=>{e.unsubscribe(),c-=1,0===c&&(d.next(r.none),i(r.none))}}),[t]),s.createElement(n.u.Context.Provider,{value:d.pipe(a.oA)},e));let c=0;const d=new o.X(r.none)},58541:e=>{e.exports={highlightRect:"QY8r6"}},74229:e=>{e.exports={ideateButton:"uvaxX",ideateButtonIcon:"FxRsU",spin:"Dl_cd"}},73734:e=>{e.exports={entryButton:"NpkKC",entryButtonItem:"qkhc6",rewriteIcon:"KF9IT",openIcon:"wnIMZ",spin:"VCOho"}},62810:e=>{e.exports={replyButton:"d5jYx",icon:"wJ_DO",spin:"N20SX"}},60688:e=>{e.exports={quasiCaret:"W8Ec1",icon:"wlLHd"}}}]);